# Original source: Docusaurus documentation

name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - '**'
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip Docusaurus build (for testing deploy only)'
        required: false
        default: 'false'
        type: boolean
      limit_docs:
        description: 'Limit vectorstore docs to first N (for testing only, 0=unlimited)'
        required: false
        default: '0'
        type: string
      skip_vectorstore:
        description: 'Skip vectorstore build job (for testing deploy only)'
        required: false
        default: 'false'
        type: boolean
      skip_storage_upload:
        description: 'Skip uploading vectorstore to Azure Files (update env only)'
        required: false
        default: 'false'
        type: boolean
concurrency:
  group:
    ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions: read-all

jobs:
  build:
    name: Build Docusaurus
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version: 22
          cache: npm

      - name: Node modules cache
        id: modules-cache
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: ${{ steps.modules-cache.outputs.cache-hit != 'true' }}
        run: npm ci

      - name: Build website
        if: ${{ github.event.inputs.skip_build != 'true' }}
        run: npm run build

      - name: Upload Build Artifact
        if: ${{ github.event.inputs.skip_build != 'true' }}
        uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
        with:
          path: build

      - name: Upload Docs Export Artifact
        if: ${{ github.event.inputs.skip_build != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: docs-export
          path: build/export
          if-no-files-found: error
          retention-days: 7

  build-vectorstore:
    name: Build Chroma Vectorstore
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: ${{ github.event.inputs.skip_vectorstore != 'true' }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download Docs Export Artifact
        uses: actions/download-artifact@v4
        with:
          name: docs-export
          path: export

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'tools/build-chroma/requirements.txt'

      - name: Cache HuggingFace models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-huggingface-all-MiniLM-L6-v2

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/build-chroma/requirements.txt

      - name: Build vectorstore
        run: |
          python tools/build-chroma/build_vectorstore.py \
            --source-docs export \
            --output-dir chroma_db \
            --collection-name ed-fi-docs \
            --embedding-model sentence-transformers/all-MiniLM-L6-v2 \
            --device cpu \
            --limit-docs ${{ github.event.inputs.limit_docs || 0 }}

      - name: Validate vectorstore build
        run: |
          echo "Validating ChromaDB build..."
          if [ ! -f "chroma_db/chroma.sqlite3" ]; then
            echo "‚ùå Error: chroma.sqlite3 not found"
            exit 1
          fi

          # Find collection directories (UUID format)
          collection_dirs=$(find chroma_db -type d -regex '.*/[a-f0-9-]\{36\}' | wc -l)
          if [ "$collection_dirs" -eq 0 ]; then
            echo "‚ùå Error: No collection directories found"
            exit 1
          fi

          # Check if collection directories have data files
          for dir in $(find chroma_db -type d -regex '.*/[a-f0-9-]\{36\}'); do
            file_count=$(find "$dir" -type f | wc -l)
            if [ "$file_count" -eq 0 ]; then
              echo "‚ùå Error: Collection directory $dir is empty"
              exit 1
            fi
            echo "‚úÖ Collection directory $(basename $dir) has $file_count files"
          done

          # Display total size
          total_size=$(du -sh chroma_db | cut -f1)
          echo "‚úÖ ChromaDB build validated successfully (size: $total_size)"

      - name: Upload Vectorstore Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vectorstore
          path: chroma_db
          retention-days: 7

  azure-deploy:
    name: Deploy Vectorstore to Azure
    needs: build-vectorstore
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
      AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
      AZURE_CONTAINERAPP_NAME: ${{ secrets.AZURE_CONTAINERAPP_NAME }}
      FILE_SHARE_NAME: vector-data
      IS_MAIN: ${{ github.ref == 'refs/heads/main' }}
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
      SHORT_SHA: ${{ github.sha }}
    steps:
      - name: Download Vectorstore Artifact
        if: ${{ github.event.inputs.skip_storage_upload != 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: vectorstore
          path: vectorstore

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # ========== STAGING PATH (Feature Branches) ==========
      - name: Upload vectorstore to Azure Files (staging)
        if: ${{ env.IS_MAIN != 'true' && github.event.inputs.skip_storage_upload != 'true' }}
        run: |
          DEST_PATH="docs-vectordb-${{ env.BRANCH_NAME }}"
          az storage file upload-batch \
            --account-name "$AZURE_STORAGE_ACCOUNT" \
            --destination "$FILE_SHARE_NAME" \
            --destination-path "$DEST_PATH" \
            --source "vectorstore" \
            --auth-mode login \
            --enable-file-backup-request-intent
          echo "DEST_PATH=$DEST_PATH" >> $GITHUB_ENV

      - name: Direct deploy to staging
        if: ${{ env.IS_MAIN != 'true' }}
        run: |
          az containerapp update \
            --name "$AZURE_CONTAINERAPP_NAME" \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --set-env-vars CHROMA_DATA_PATH="/data/${{ env.DEST_PATH }}"
          echo "‚úÖ Staging deployment complete"
          echo "Environment: /data/${{ env.DEST_PATH }}"
          echo "Branch: ${{ env.BRANCH_NAME }}"

      # ========== PRODUCTION PATH (Main Branch) - CI Revision ==========
      - name: Set CI revision name
        if: ${{ env.IS_MAIN == 'true' }}
        run: |
          CI_REVISION="ci-${SHORT_SHA:0:7}"
          DEST_PATH="docs-vectordb-ci-${SHORT_SHA:0:7}"
          echo "CI_REVISION=$CI_REVISION" >> $GITHUB_ENV
          echo "DEST_PATH=$DEST_PATH" >> $GITHUB_ENV
          echo "üì¶ CI Revision: $CI_REVISION"
          echo "üìÅ Data Path: /data/$DEST_PATH"

      - name: Upload vectorstore to Azure Files (production CI path)
        if: ${{ env.IS_MAIN == 'true' && github.event.inputs.skip_storage_upload != 'true' }}
        run: |
          az storage file upload-batch \
            --account-name "$AZURE_STORAGE_ACCOUNT" \
            --destination "$FILE_SHARE_NAME" \
            --destination-path "${{ env.DEST_PATH }}" \
            --source "vectorstore" \
            --auth-mode login \
            --enable-file-backup-request-intent
          echo "‚úì Uploaded to /data/${{ env.DEST_PATH }}"

      - name: Update container app with new vectorstore
        if: ${{ env.IS_MAIN == 'true' }}
        run: |
          echo "üöÄ Updating container app with CI revision: ${{ env.CI_REVISION }}"
          az containerapp update \
            --name "$AZURE_CONTAINERAPP_NAME" \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --set-env-vars CHROMA_DATA_PATH="/data/${{ env.DEST_PATH }}" \
            --revision-suffix "${{ env.CI_REVISION }}"

          echo "‚úÖ Deployment complete!"
          echo "  CI Revision: ${{ env.CI_REVISION }}"
          echo "  Data Path: /data/${{ env.DEST_PATH }}"

  deploy:
    name: Deploy to GitHub Pages
    needs: build
    if: ${{ github.ref == 'refs/heads/main' }}

    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write # to deploy to Pages
      id-token: write # to verify the deployment originates from an appropriate source

    # Deploy to the github-pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
