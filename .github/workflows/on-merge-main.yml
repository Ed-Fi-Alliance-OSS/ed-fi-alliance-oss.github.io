# Original source: Docusaurus documentation

name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - '**'
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip Docusaurus build (for testing deploy only)'
        required: false
        default: 'false'
        type: boolean
      limit_docs:
        description: 'Limit vectorstore docs to first N (for testing only, 0=unlimited)'
        required: false
        default: '0'
        type: string
      skip_vectorstore:
        description: 'Skip vectorstore build job (for testing deploy only)'
        required: false
        default: 'false'
        type: boolean
      skip_storage_upload:
        description: 'Skip uploading vectorstore to Azure Files (update env only)'
        required: false
        default: 'false'
        type: boolean
concurrency:
  group:
    ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions: read-all

jobs:
  build:
    name: Build Docusaurus
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version: 22
          cache: npm

      - name: Node modules cache
        id: modules-cache
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: ${{ steps.modules-cache.outputs.cache-hit != 'true' }}
        run: npm ci

      - name: Build website
        if: ${{ github.event.inputs.skip_build != 'true' }}
        run: npm run build

      - name: Upload Build Artifact
        if: ${{ github.event.inputs.skip_build != 'true' }}
        uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
        with:
          path: build

      - name: Upload Docs Export Artifact
        if: ${{ github.event.inputs.skip_build != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: docs-export
          path: build/export
          if-no-files-found: error
          retention-days: 7

  build-vectorstore:
    name: Build Chroma Vectorstore
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: ${{ github.event.inputs.skip_vectorstore != 'true' }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download Docs Export Artifact
        uses: actions/download-artifact@v4
        with:
          name: docs-export
          path: export

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'tools/build-chroma/requirements.txt'

      - name: Cache HuggingFace models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-huggingface-all-MiniLM-L6-v2

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/build-chroma/requirements.txt

      - name: Azure Login (for HTTP mode)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get ChromaDB server URL
        id: get-server-url
        run: |
          FQDN=$(az containerapp show \
            --name ${{ secrets.AZURE_CONTAINERAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          SERVER_URL="https://${FQDN}"
          echo "SERVER_URL=$SERVER_URL" >> $GITHUB_OUTPUT
          echo "üåê ChromaDB Server: $SERVER_URL"

      - name: Build vectorstore (HTTP mode)
        env:
          SERVER_URL: ${{ steps.get-server-url.outputs.SERVER_URL }}
        run: |
          python tools/build-chroma/build_vectorstore.py \
            --source-docs export \
            --server-url "$SERVER_URL" \
            --collection-name ed-fi-docs \
            --embedding-model sentence-transformers/all-MiniLM-L6-v2 \
            --device cpu \
            --batch-size 500 \
            --http-timeout 300 \
            --limit-docs ${{ github.event.inputs.limit_docs || 0 }}

      - name: Verify remote collection
        env:
          SERVER_URL: ${{ steps.get-server-url.outputs.SERVER_URL }}
        run: |
          echo "Verifying remote ChromaDB collection..."
          # Simple verification via heartbeat
          if curl -f "${SERVER_URL}/api/v1/heartbeat" > /dev/null 2>&1; then
            echo "‚úÖ ChromaDB server is responsive"
          else
            echo "‚ùå ChromaDB server healthcheck failed"
            exit 1
          fi

  azure-deploy:
    name: Label Deployment
    needs: build-vectorstore
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
      AZURE_CONTAINERAPP_NAME: ${{ secrets.AZURE_CONTAINERAPP_NAME }}
      IS_MAIN: ${{ github.ref == 'refs/heads/main' }}
      SHORT_SHA: ${{ github.sha }}
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Label current revision as CI
        if: ${{ env.IS_MAIN == 'true' }}
        run: |
          CI_LABEL="ci-${SHORT_SHA:0:7}"
          CURRENT_REVISION=$(az containerapp revision list \
            --name "$AZURE_CONTAINERAPP_NAME" \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --query "[?properties.active==\`true\`].name" \
            -o tsv | head -n 1)
          
          echo "üì¶ Labeling revision $CURRENT_REVISION with: $CI_LABEL"
          az containerapp revision label add \
            --name "$AZURE_CONTAINERAPP_NAME" \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --label "$CI_LABEL" \
            --revision "$CURRENT_REVISION"
          
          echo "‚úÖ Deployment labeled!"
          echo "  Revision: $CURRENT_REVISION"
          echo "  Label: $CI_LABEL"

  deploy:
    name: Deploy to GitHub Pages
    needs: build
    if: ${{ github.ref == 'refs/heads/main' }}

    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write # to deploy to Pages
      id-token: write # to verify the deployment originates from an appropriate source

    # Deploy to the github-pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
